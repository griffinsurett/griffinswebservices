function m(t,{threshold:e=.1,root:s=null,rootMargin:i="0px",once:n=!1,onEnter:r,onExit:l}={}){let o=!1,a=!1,c=null;return!t||typeof IntersectionObserver>"u"?{isVisible:o,hasBeenSeen:a,disconnect:()=>{}}:(c=new IntersectionObserver(S=>{const u=S[0];if(!u)return;const f=u.isIntersecting;o=f,f?(a||(a=!0),r?.(u),n&&c?.disconnect()):l?.(u)},{threshold:e,root:s,rootMargin:i}),c.observe(t),{get isVisible(){return o},get hasBeenSeen(){return a},disconnect:()=>c?.disconnect()})}class v{subscribers=new Set;lastScrollY=0;lastDirection="down";initialized=!1;rafId=null;pendingUpdate=!1;init(){this.initialized||typeof window>"u"||(this.initialized=!0,this.lastScrollY=0,window.addEventListener("scroll",this.handleScroll,{passive:!0}),window.addEventListener("wheel",this.handleWheel,{passive:!0}))}handleScroll=()=>{this.pendingUpdate||(this.pendingUpdate=!0,this.rafId=requestAnimationFrame(()=>{this.pendingUpdate=!1;const e=window.scrollY,s=e-this.lastScrollY;s!==0&&(this.lastDirection=s>0?"down":"up",this.lastScrollY=e,this.notify({direction:this.lastDirection,scrollY:e,deltaY:s,source:"scroll",timestamp:performance.now()}))}))};handleWheel=e=>{if(e.deltaY===0)return;const s=e.deltaY>0?"down":"up";this.lastDirection=s,this.notify({direction:s,scrollY:window.scrollY,deltaY:e.deltaY,source:"wheel",timestamp:performance.now()})};notify(e){this.subscribers.forEach(s=>{try{s(e)}catch(i){console.error("ScrollEventBus subscriber error:",i)}})}subscribe(e){return this.init(),this.subscribers.add(e),()=>{this.subscribers.delete(e)}}getLastDirection(){return this.lastDirection}getLastScrollY(){return this.lastScrollY}destroy(){!this.initialized||typeof window>"u"||(window.removeEventListener("scroll",this.handleScroll),window.removeEventListener("wheel",this.handleWheel),this.rafId!==null&&cancelAnimationFrame(this.rafId),this.subscribers.clear(),this.initialized=!1)}}const h=new v;typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>h.init(),{once:!0}):h.init());function p(t){return t instanceof HTMLVideoElement?!!(t.dataset.videoSrc||t.querySelector("source[data-video-src]")):!1}function w(t){if(t.dataset.videoLoaded==="true")return!0;let e=!1;const s=t.dataset.videoSrc;return s&&t.src!==s&&(t.src=s,e=!0),t.querySelectorAll("source[data-video-src]").forEach(n=>{const r=n.dataset.videoSrc;r&&n.src!==r&&(n.src=r,e=!0)}),e&&(t.load(),t.dataset.videoLoaded="true"),e}function E(t){if(!(t.dataset.videoAutoplay!=="false"))return;const s=t.play();typeof s?.catch=="function"&&s.catch(()=>{})}function y(t){t.dataset.videoPause!=="false"&&t.pause()}function g(t){if(!p(t))return;w(t)&&E(t)}function M(t){p(t)&&y(t)}class T{observedElements=new WeakSet;disconnectors=new WeakMap;seenElements=new WeakSet;defaultThreshold;defaultRootMargin;scrollDirection="down";unsubscribeScroll=null;mutationDebounceTimer=null;pendingMutations=[];constructor(e={}){this.defaultThreshold=e.defaultThreshold??.1,this.defaultRootMargin=e.defaultRootMargin??"0px 0px -50px 0px"}init(){typeof window>"u"||typeof IntersectionObserver>"u"||(this.unsubscribeScroll=h.subscribe(this.handleScrollEvent),requestAnimationFrame(()=>{this.observeAll(),this.setupMutationObserver()}))}handleScrollEvent=e=>{this.scrollDirection=e.direction};observeAll(){document.querySelectorAll("[data-animate]").forEach(i=>this.observe(i)),CSS.supports("animation-timeline: view()")||document.querySelectorAll("[data-animate-css]").forEach(n=>this.observeCSS(n))}observe(e){if(this.observedElements.has(e))return;this.observedElements.add(e);const s=e.dataset.animateOnce==="true",i=parseInt(e.dataset.animateDelay||"0",10),n=e.dataset.animateThreshold?parseFloat(e.dataset.animateThreshold):this.defaultThreshold,r=e.dataset.animateRootMargin||this.defaultRootMargin,{disconnect:l}=m(e,{threshold:n,rootMargin:r,once:s,onEnter:()=>{g(e),this.seenElements.add(e),delete e.dataset.exitDirection,i>0?setTimeout(()=>{e.dataset.visible="true"},i):e.dataset.visible="true"},onExit:()=>{!s&&this.seenElements.has(e)&&(e.dataset.exitDirection=this.scrollDirection,e.dataset.visible="false"),M(e)}});this.disconnectors.set(e,l)}observeCSS(e){if(this.observedElements.has(e))return;this.observedElements.add(e);const s=e.dataset.animateCss;s&&(e.dataset.animate=s);const i=!0,{disconnect:n}=m(e,{threshold:this.defaultThreshold,rootMargin:this.defaultRootMargin,once:i,onEnter:()=>{e.dataset.visible="true"},onExit:()=>{}});this.disconnectors.set(e,n)}setupMutationObserver(){const e=CSS.supports("animation-timeline: view()"),s=100,i=()=>{const r=this.pendingMutations;this.pendingMutations=[],this.mutationDebounceTimer=null;for(const l of r)for(const o of l.addedNodes)o instanceof HTMLElement&&(o.hasAttribute("data-animate")&&this.observe(o),o.querySelectorAll?.("[data-animate]").forEach(a=>{this.observe(a)}),e||(o.hasAttribute("data-animate-css")&&this.observeCSS(o),o.querySelectorAll?.("[data-animate-css]").forEach(a=>{this.observeCSS(a)})))};new MutationObserver(r=>{this.pendingMutations.push(...r),this.mutationDebounceTimer!==null&&clearTimeout(this.mutationDebounceTimer),this.mutationDebounceTimer=setTimeout(i,s)}).observe(document.body,{childList:!0,subtree:!0})}}let d=null;function b(t){return d||(d=new T(t),d.init(),d)}if(typeof window<"u"){const t=()=>{"requestIdleCallback"in window?window.requestIdleCallback(()=>b(),{timeout:100}):setTimeout(()=>b(),0)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}export{m as c,h as s};
