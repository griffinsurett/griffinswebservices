---
import type { BaseVariantProps } from "../ContentRenderer.types";
import IconListItem from "@/components/LoopComponents/IconListItem";
import SectionHeader from "@/components/SectionHeader.astro";
import { toArray } from "@/utils/array";

interface HeadingContent {
  title?: string;
  before?: string;
  text?: string;
  after?: string;
  description?: string;
}

interface Props extends BaseVariantProps {
  columns?: 1 | 2 | 3;
  gap?: "sm" | "md" | "lg";
  heading?: HeadingContent;
}

const {
  items = [],
  title,
  collectionTitle,
  heading,
  description,
  className = "",
  columns = 2,
  gap = "lg",
  id,
} = Astro.props as Props;

const safeItems = toArray(items);
const headingTitle = heading?.title ?? title ?? collectionTitle;
const headingBefore = heading?.before;
const headingText = heading?.text;
const headingAfter = heading?.after;
const headingDescription = heading?.description ?? description;
const showHeader = Boolean(
  headingTitle ?? headingDescription ?? headingBefore ?? headingText ?? headingAfter,
);

const gapClasses: Record<"sm" | "md" | "lg", string> = {
  sm: "gap-6",
  md: "gap-8",
  lg: "gap-10",
};

const resolveItemUrl = (item: Record<string, any>): string | undefined => {
  if (!item || typeof item !== "object") return undefined;
  const candidates = [
    item.url,
    item.href,
    item.link,
    item.route,
    item?.data?.url,
  ];
  return candidates.find(
    (value): value is string => typeof value === "string" && value.trim().length > 0,
  );
};
---

<section id={id} class={`py-16 ${className}`.trim()}>
  <div class="mx-auto inner-section">
    <div
      class={`flex flex-col lg:space-x-25 gap-6 ${
        showHeader ? "lg:flex-row lg:items-start" : ""
      }`.trim()}
    >
      {showHeader && (
        <div class="w-full lg:w-1/3 lg:sticky lg:top-0 lg:self-start">
          <SectionHeader
            title={headingTitle}
            heading={headingText ?? headingTitle}
            headingBefore={headingBefore}
            headingEmphasis={headingText}
            headingAfter={headingAfter}
            description={headingDescription}
            className="space-y-4 text-left"
            headingClassName="h2 text-heading"
            descriptionClassName="text-lg text-muted leading-relaxed"
            titleVisibleRootMargin={0}
          />
        </div>
      )}

      {safeItems.length > 0 && (
        <div class={`w-full py-6 lg:py-0 ${showHeader ? "lg:w-2/3" : ""}`.trim()}>
          <ul class={`flex flex-col ${gapClasses[gap]} list-none`.trim()}>
            {safeItems.map((item) => {
              const route = resolveItemUrl(item);
              const linkLabel =
                typeof item?.title === "string"
                  ? item.title
                  : typeof item?.heading === "string"
                  ? item.heading
                  : "Open link";

              return (
                <li class="relative h-full group">
                  {route ? (
                    <a
                      href={route}
                      class="block relative cursor-pointer focus:outline-none"
                      aria-label={`Open ${linkLabel}`}
                    >
                      <IconListItem
                        data={item}
                        layout="vertical"
                        alignment="left"
                        className="items-start text-left gap-1 pr-12 group-hover:opacity-90 transition-opacity duration-300"
                        iconClassName="icon-large card-icon-color mb-3"
                        iconSize="xl"
                        titleClassName="h3 text-heading"
                        descriptionClassName="text-base text-muted leading-relaxed"
                      />

                      <span
                        aria-hidden="true"
                        class="absolute top-3 right-3 w-10 h-10 rounded-full flex items-center justify-center bg-primary/15 text-accent text-lg font-semibold border border-primary/20 opacity-0 transition-all duration-300 group-hover:opacity-100 group-hover:bg-primary group-hover:text-bg"
                      >
                        â†—
                      </span>
                    </a>
                  ) : (
                    <div class="relative">
                      <IconListItem
                        data={item}
                        layout="vertical"
                        alignment="left"
                        className="items-start text-left gap-1 pr-12"
                        iconClassName="icon-large card-icon-color mb-3"
                        iconSize="xl"
                        titleClassName="h3 text-heading"
                        descriptionClassName="text-base text-muted leading-relaxed"
                      />
                    </div>
                  )}
                </li>
              );
            })}
          </ul>
        </div>
      )}
    </div>
  </div>
</section>
