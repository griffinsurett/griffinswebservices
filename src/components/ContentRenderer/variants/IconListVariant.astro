---
// IconListVariant.astro
import type { BaseVariantProps } from "../ContentRenderer.types";
import IconListItem from "@/components/LoopComponents/IconListItem";
import FeatureCard from "@/components/LoopComponents/FeatureCard";
import SectionHeader from "@/components/SectionHeader.astro";
import { toArray } from "@/utils/array";

interface HeadingContent {
    title?: string;
    before?: string;
    text?: string;
    after?: string;
    description?: string;
}

interface Props extends BaseVariantProps {
    columns?: 1 | 2 | 3;
    gap?: "sm" | "md" | "lg";
    heading?: HeadingContent;
    itemLayout?: "vertical" | "horizontal" | "horizontal-reverse";
    slotContainerClassName?: string;
}

const {
    items = [],
    title,
    collectionTitle,
    heading,
    headingTag,
    headingClassName = "text-3xl md:text-4xl lg:text-5xl leading-[1.15em] text-heading",
    description,
    className = "",
    columns = 2,
    gap = "lg",
    id,
    itemLayout = "horizontal",
    slotContainerClassName = "",
} = Astro.props as Props;

const hasSlotContent = Astro.slots.has("default");

const safeItems = toArray(items);
const headingTitle = heading?.title ?? title ?? collectionTitle;
const headingBefore = heading?.before;
const headingText = heading?.text;
const headingAfter = heading?.after;
const headingDescription = heading?.description ?? description;
const showHeader = Boolean(
    headingTitle ??
        headingDescription ??
        headingBefore ??
        headingText ??
        headingAfter,
);

const resolveItemUrl = (item: Record<string, any>): string | undefined => {
    if (!item || typeof item !== "object") return undefined;
    const candidates = [
        item.url,
        item.href,
        item.link,
        item.route,
        item?.data?.url,
    ];
    return candidates.find(
        (value): value is string =>
            typeof value === "string" && value.trim().length > 0,
    );
};
---

<section id={id} class={`py-16 ${className}`.trim()}>
    <div class="mx-auto inner-section">
        <div
            class={`flex flex-col lg:space-x-15 ${
                showHeader ? "lg:flex-row lg:items-start" : ""
            }`.trim()}
        >
            {
                showHeader && (
                    <div class="w-full lg:w-1/2 sticky-section lg:self-start">
                        <SectionHeader
                            title={headingTitle}
                            headingBefore={headingBefore}
                            headingEmphasis={headingText}
                            headingAfter={headingAfter}
                            description={headingDescription}
                            className="space-y-4 text-left w-full"
                            headingTag={headingTag}
                            headingClassName={headingClassName}
                            descriptionClassName="large-text leading-relaxed"
                            titleVisibleRootMargin={0}
                        />

                        {Astro.slots.has("under-text") && (
                            <div class="mt-8">
                                <slot name="under-text" />
                            </div>
                        )}
                    </div>
                )
            }

            {
                safeItems.length > 0 && (
                    <div
                        class={`w-full py-6 lg:py-0 ${showHeader ? "lg:w-1/2" : ""}`.trim()}
                    >
                        <ul
                            class={`flex flex-col gap-4 list-none`.trim()}
                        >
                            {safeItems.map((item) => {
                                const route = resolveItemUrl(item);
                                const linkLabel =
                                    typeof item?.title === "string"
                                        ? item.title
                                        : typeof item?.heading === "string"
                                          ? item.heading
                                          : "Open link";

                                return (
                                    <li
                                        class="relative"
                                        data-animate="fade-in-up"
                                        data-animate-once="true"
                                    >
                                        {route ? (
                                            <FeatureCard
                                                client:visible
                                                data={{ ...item, url: route }}
                                                ringDuration={800}
                                                listItemProps={{
                                                    layout: itemLayout,
                                                    alignment: "left",
                                                    className: "gap-1 w-full flex items-start",
                                                    iconClassName: "icon-large card-icon-color mr-4",
                                                    iconSize: "xl",
                                                    titleTag: "h3",
                                                    titleClassName: "text-heading h3 my-4",
                                                    descriptionClassName: "text-lg text-text",
                                                }}
                                            />
                                        ) : (
                                            <div class="p-6 lg:p-8">
                                                <IconListItem
                                                    data={item}
                                                    layout={itemLayout}
                                                    alignment="left"
                                                    className="text-left gap-1 w-full flex items-start"
                                                    iconClassName="icon-large card-icon-color mr-4"
                                                    iconSize="xl"
                                                    titleTag="h3"
                                                    titleClassName="text-heading h3 my-4"
                                                    descriptionClassName="text-lg text-text"
                                                />
                                            </div>
                                        )}
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                )
            }
        </div>

        {hasSlotContent && (
            <div class={`mt-8 ${slotContainerClassName}`.trim()}>
                <slot />
            </div>
        )}
    </div>
</section>
