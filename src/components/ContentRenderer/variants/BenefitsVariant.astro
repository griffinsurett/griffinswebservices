---
// src/components/ContentRenderer/variants/BenefitsVariant.astro
/**
 * BenefitsVariant
 * Grid-based layout for benefits with optional MDX body content via ContentBridge.
 * Uses CardRenderer with GridCard for clean icon + title + body display.
 */

import type { BaseVariantProps } from "../ContentRenderer.types";
import type { FeatureCardData } from "@/components/LoopComponents/FeatureCard";
import ContentBridge from "../ContentBridge/ContentBridge.astro";
import CardRenderer from "@/components/LoopTemplates/CardRenderer";
import SectionHeader from "@/components/SectionHeader.astro";
import Button from "@/components/Button/Button";
import { shouldShowCollectionCTA } from "../utils/helpers";
import { toArray } from "@/utils/array";

interface Props extends BaseVariantProps {
  columns?: 2 | 3 | 4;
  ctaHref?: string;
  ctaText?: string;
  /** Show MDX body content in cards instead of description */
  showBody?: boolean;
}

const {
  items = [],
  title,
  heading,
  description,
  className = "outer-section",
  columns = 3,
  collectionUrl,
  collectionTitle,
  id,
  showButtonSection = true,
  ctaHref,
  ctaText,
  showBody = true,
} = Astro.props as Props;

const safeItems = toArray(items) as FeatureCardData[];
const sectionTitle = title ?? collectionTitle;

// SectionHeader handles heading normalization automatically
const showHeader = Boolean(sectionTitle || heading || description);
const gridMarginClass = showHeader ? "mt-12" : "";
const showCTA =
  showButtonSection &&
  shouldShowCollectionCTA(collectionUrl, safeItems.length) &&
  (ctaText || title || collectionTitle) &&
  (ctaHref || collectionUrl);
---

<section id={id} class={`relative overflow-hidden ${className}`.trim()}>
  <div class="inner-section">
    {showHeader && (
      <div class="heading-padding">
        <SectionHeader
          title={sectionTitle}
          heading={heading}
          description={description}
          className="text-section"
        />
      </div>
    )}

    <ContentBridge items={safeItems} bridgeId={id}>
      <Fragment slot="default">
        <CardRenderer
          client:visible
          items={safeItems.map((item, index) => ({
            ...item,
            contentSlotId: `${id}-slot-${index}`,
          }))}
          columns={columns}
          showBody={showBody}
          className={gridMarginClass}
          featureCardProps={{
            listItemProps: {
              showIcon: false,
              alignment: "left",
            },
          }}
          animation={{
            once: false,
            threshold: 0.15,
            rootMargin: "-10% 0px -10% 0px",
          }}
        />
      </Fragment>
    </ContentBridge>

    {showCTA && (
      <div class="buttons-section-center">
        <Button
          href={ctaHref ?? collectionUrl}
          rightIcon="lu:arrow-right"
          variant="secondary"
          client:idle
        >
          {ctaText ?? `View All ${(title ?? collectionTitle ?? "").trim()}`}
        </Button>
      </div>
    )}
  </div>
</section>
