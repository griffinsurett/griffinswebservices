---
// src/components/LoopTemplates/MasonryGrid.astro
/**
 * MasonryGrid - 2-column layout with balanced distribution
 * Each card is rendered as a slot for individual hydration
 * Cards fade in on scroll
 */

export interface MasonryCardData {
  title: string;
  description?: string;
  icon?: string;
  order?: number;
  Content?: any;
  /** Lazy render function - call to get Content component */
  render?: () => Promise<{ Content: any }>;
}

interface ResolvedCardData {
  title: string;
  description?: string;
  icon?: string;
  order?: number;
  Content?: any;
}

interface Props {
  items: MasonryCardData[];
  className?: string;
}

const { items, className = "" } = Astro.props;

// Resolve lazy render functions to Content components
const resolvedItems: ResolvedCardData[] = await Promise.all(
  items.map(async (item) => {
    // If Content is already provided, use it
    if (item.Content) {
      return item as ResolvedCardData;
    }
    // If render function is provided, call it to get Content
    if (item.render) {
      try {
        const { Content } = await item.render();
        return { ...item, Content } as ResolvedCardData;
      } catch (e) {
        // Fallback without Content if render fails
        return item as ResolvedCardData;
      }
    }
    return item as ResolvedCardData;
  })
);

// Distribute items into columns for balanced heights
// Alternates items between left and right columns
const leftColumn: ResolvedCardData[] = [];
const rightColumn: ResolvedCardData[] = [];

resolvedItems.forEach((item, index) => {
  if (index % 2 === 0) {
    leftColumn.push(item);
  } else {
    rightColumn.push(item);
  }
});
---

<div class={`masonry-grid ${className}`}>
  <div class="masonry-column">
    {leftColumn.map((item) => (
      <article
        class="masonry-card"
        data-animate="fade-in-up"
        data-animate-threshold="0.15"
        data-animate-root-margin="-10% 0px -10% 0px"
      >
        <h3 class="text-xl font-semibold text-text mb-2">{item.title}</h3>
        {item.description && (
          <p class="text-sm text-text/60 leading-relaxed">{item.description}</p>
        )}
        {item.Content && (
          <div class="masonry-content mt-4">
            <item.Content />
          </div>
        )}
      </article>
    ))}
  </div>
  <div class="masonry-column">
    {rightColumn.map((item) => (
      <article
        class="masonry-card"
        data-animate="fade-in-up"
        data-animate-threshold="0.15"
        data-animate-root-margin="-10% 0px -10% 0px"
      >
        <h3 class="text-xl font-semibold text-text mb-2">{item.title}</h3>
        {item.description && (
          <p class="text-sm text-text/60 leading-relaxed">{item.description}</p>
        )}
        {item.Content && (
          <div class="masonry-content mt-4">
            <item.Content />
          </div>
        )}
      </article>
    ))}
  </div>
</div>
